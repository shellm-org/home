#!/usr/bin/env bash

## \brief Quick command to create a new script.

## \env SHELLM_NEW_DIR
## Path to the directory where new files are created.

if ! shellm-include shellm/shellman/lib/shellman.sh; then
  shellm-include shellm-org/shellman/lib/shellman.sh  # github mirror
fi

[ $# -eq 0 ] && shellman_usage

main() {
  case "$1" in
    ## \option -h, --help
    ## Print this help and exit.
    -h|--help) shellman "$0"; exit 0 ;;
  esac

  # Test if the directory exists
  if [ ! -d "${SHELLM_NEW_DIR}" ]; then
    echo "new: directory ${SHELLM_NEW_DIR:-SHELLM_NEW_DIR} does not exist" >&2
    exit 1
  fi

  # Test if the script already exists
  # shellcheck disable=SC2154
  if [ -f "${SHELLM_NEW_DIR}/$1" ]; then
    echo "new: $1 already exists in ${SHELLM_NEW_DIR}" >&2
    exit 1
  fi

  {
    echo '#!/bin/bash'
    echo
    echo '## \brief '"$1"
    # shellcheck disable=SC2028
    echo '## \require coreutils'
    echo
    echo "shellm-include shellm/shellman/lib/shellman.sh"
    echo
    echo '[ $# -eq 0 ] && shellman_usage'
    echo
    echo 'main() {'
    # shellcheck disable=SC2016
    echo '  case $1 in'
    echo '    ## \option -h, --help'
    echo '    ## Print this help and exit.'
    # shellcheck disable=SC2016
    echo '    -h|--help) shellman "$0"; exit 0 ;;'
    echo "  esac"
    echo "}"
    echo
    echo '## \usage '"$1"
    echo 'main "$@"'
	} >"${SHELLM_NEW_DIR}/$1"

  # Make it executable
  chmod +x "${SHELLM_NEW_DIR}/$1"

  # Open the file
  editor "${SHELLM_NEW_DIR}/$1"
}

## \usage new <FILENAME>
main "$@"
